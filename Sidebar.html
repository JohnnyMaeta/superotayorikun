<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç´šé€šä¿¡æ–‡ç« ä½œæˆãã‚“</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0; padding: 16px; line-height: 1.6; font-size: 14px; color: #333; background-color: #fafafa;
    }
    .container { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 16px; }
    h2 { margin: 0 0 16px 0; font-size: 18px; color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 8px; }
    .form-group { margin-bottom: 16px; }
    label { display: block; margin-bottom: 4px; font-weight: 500; color: #555; }
    input[type="text"], input[type="number"], input[type="password"], select, textarea {
      width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;
    }
    textarea { resize: vertical; min-height: 80px; }
    button { background: #1976d2; color: white; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%; margin-bottom: 8px; }
    button:hover { background: #1565c0; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #757575; }
    .btn-secondary:hover { background: #616161; }
    .btn-danger { background: #d32f2f; }
    .btn-danger:hover { background: #c62828; }
    .btn-debug { background: #ff9800; font-size: 12px; padding: 6px 12px; }
    .btn-debug:hover { background: #f57c00; }
    .status { padding: 12px; border-radius: 4px; margin-bottom: 16px; font-size: 13px; }
    .status-info { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
    .status-success { background: #e8f5e8; color: #2e7d32; border: 1px solid #c8e6c9; }
    .status-warning { background: #fff3e0; color: #f57c00; border: 1px solid #ffcc02; }
    .status-error { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
    .small-text { font-size: 12px; color: #666; margin-top: 4px; }
    .loading { display: none; text-align: center; padding: 20px; color: #666; }
    .loading.show { display: block; }
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #1976d2; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .debug-section { background: #fff3e0; border: 1px solid #ffcc02; border-radius: 4px; padding: 12px; margin-top: 16px; }
    .debug-section h4 { margin: 0 0 8px 0; color: #f57c00; font-size: 14px; }
    .cell-info { font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 4px 8px; border-radius: 3px; margin: 4px 0; }
  </style>
</head>
<body>
  <div id="status"></div>

  <div class="container">
    <h2>ğŸ“ å­¦ç´šé€šä¿¡ã‚’ä½œæˆ</h2>
    
    <div class="form-group">
      <label for="memoText">ç®‡æ¡æ›¸ããƒ¡ãƒ¢ï¼ˆå¿…é ˆï¼‰</label>
      <textarea id="memoText" placeholder="ä¾‹ï¼š&#10;é‹å‹•ä¼šã®ç·´ç¿’ã‚’é ‘å¼µã£ã¦ã„ã‚‹æ§˜å­&#10;ãƒªãƒ¬ãƒ¼ã®é¸æ‰‹ãŒæ±ºã¾ã£ãŸã“ã¨&#10;ä¿è­·è€…ã¸ã®å¿œæ´ã®ãŠé¡˜ã„"></textarea>
      <button type="button" onclick="loadSelectedCells()" class="btn-secondary">é¸æŠã‚»ãƒ«ã®å†…å®¹ã‚’å–å¾—</button>
      <div class="small-text">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ã‚»ãƒ«ã‚’é¸æŠã—ã¦ã‹ã‚‰ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å†…å®¹ã‚’ãƒ¡ãƒ¢æ¬„ã«å–ã‚Šè¾¼ã‚ã¾ã™</div>
    </div>

    <div class="form-group">
  <label for="goalCode">ä¸»ãªç›®çš„</label>
  <select id="goalCode">
    <option value="A">è¡Œäº‹ã®å ±å‘Šãƒ»é€£çµ¡</option>
    <option value="B" selected>æ—¥å¸¸æ´»å‹•ã®å ±å‘Š</option>
    <option value="C">ä¿è­·è€…ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</option>
    <option value="D">ãã®ä»–ï¼ˆãƒ¡ãƒ¢å†…å®¹æœ€å„ªå…ˆï¼‰</option>
  </select>
</div>

    <div class="form-group">
      <label for="charCount">ãŠã‚ˆãã®æ–‡å­—æ•°ï¼ˆä»»æ„ï¼‰</label>
      <input type="number" id="charCount" placeholder="ä¾‹: 400" min="100" max="1000" step="50">
      <div class="small-text">ç©ºæ¬„ã®å ´åˆã¯ç›®çš„ã«å¿œã˜ãŸé©åˆ‡ãªé•·ã•ã§ä½œæˆã—ã¾ã™</div>
    </div>

    <div class="form-group">
      <label for="gradeLevel">å¯¾è±¡å­¦å¹´</label>
      <select id="gradeLevel">
        <option value="elementary_1">å°å­¦1å¹´ç”Ÿ</option>
        <option value="elementary_2">å°å­¦2å¹´ç”Ÿ</option>
        <option value="elementary_3">å°å­¦3å¹´ç”Ÿ</option>
        <option value="elementary_4">å°å­¦4å¹´ç”Ÿ</option>
        <option value="elementary_5">å°å­¦5å¹´ç”Ÿ</option>
        <option value="elementary_6">å°å­¦6å¹´ç”Ÿ</option>
        <option value="middle_school">ä¸­å­¦ç”Ÿ</option>
        <option value="high_school">é«˜æ ¡ç”Ÿ</option>
      </select>
    </div>

    <button type="button" onclick="generateNewsletter()" id="generateBtn">å­¦ç´šé€šä¿¡ã‚’ä½œæˆ</button>
    <div class="small-text">â€» å‡ºåŠ›å…ˆã®ã‚»ãƒ«ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§é¸æŠã—ã¦ã‹ã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    
    <div class="debug-section">
      <h4>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</h4>
      <div id="cellInfo" class="cell-info">ç¾åœ¨ã®ã‚»ãƒ«é¸æŠçŠ¶æ³ã‚’ç¢ºèªä¸­...</div>
      <button type="button" onclick="testCellWrite()" class="btn-debug">ãƒ†ã‚¹ãƒˆæ–‡ç« ã‚’æ›¸ãè¾¼ã¿</button>
      <div class="small-text">æ›¸ãè¾¼ã¿ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™</div>
    </div>
  </div>

  <div class="container">
    <h2>ğŸ¨ ç§ã®æ–‡ä½“ã‚’å­¦ç¿’</h2>
    <div id="styleStatus"></div>
    <button type="button" onclick="createSampleSheet()" class="btn-secondary">ã‚µãƒ³ãƒ—ãƒ«ç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ</button>
    <button type="button" onclick="analyzeStyle()" id="analyzeBtn">ç§ã®æ–‡ä½“ã‚’åˆ†æã™ã‚‹</button>
    <button type="button" onclick="showProfileSheet()" class="btn-secondary">åˆ†æçµæœã‚’è¡¨ç¤ºãƒ»ç·¨é›†</button>
    <div class="small-text">
      <strong>ä½¿ã„æ–¹ï¼š</strong><br>
      1. ã€Œã‚µãƒ³ãƒ—ãƒ«ç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã€ã§ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ<br>
      2. éå»ã®å­¦ç´šé€šä¿¡ã‚’5ã€œ10ä»¶ã€Aåˆ—ã«è²¼ã‚Šä»˜ã‘<br>
      3. ã€Œç§ã®æ–‡ä½“ã‚’åˆ†æã™ã‚‹ã€ã§å­¦ç¿’å®Ÿè¡Œ
    </div>
  </div>

  <div class="container">
    <h2>âš™ï¸ è¨­å®š</h2>
    <div class="form-group">
      <label for="apiKey">Gemini APIã‚­ãƒ¼</label>
      <input type="password" id="apiKey" placeholder="AIã‚’ä½¿ã†ãŸã‚ã®ã‚­ãƒ¼ã‚’å…¥åŠ›">
      <div class="small-text">
        <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>ã§å–å¾—ã§ãã¾ã™
      </div>
    </div>
    <button type="button" onclick="saveApiKey()">APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
    <button type="button" onclick="deleteApiKey()" class="btn-danger">APIã‚­ãƒ¼ã‚’å‰Šé™¤</button>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>å‡¦ç†ä¸­ã§ã™...
  </div>

  <script>
    let initState = null;

    function init() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(state) {
          initState = state;
          updateUI();
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          showError('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          showLoading(false);
        })
        .getInitState();
    }

    function updateUI() {
      updateStatus();
      updateStyleStatus();
      updateCellInfo();
    }

    function updateStatus() {
      const statusDiv = document.getElementById('status');
      if (initState.apiKeySaved) {
        statusDiv.innerHTML = '<div class="status status-success">âœ… APIã‚­ãƒ¼ãŒè¨­å®šæ¸ˆã¿ã§ã™</div>';
      } else {
        statusDiv.innerHTML = '<div class="status status-warning">âš ï¸ APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>';
      }
    }

    function updateStyleStatus() {
      const styleDiv = document.getElementById('styleStatus');
      if (initState.styleProfileSummary) {
        const profile = initState.styleProfileSummary;
        styleDiv.innerHTML = `
          <div class="status status-success">
            <strong>âœ… æ–‡ä½“åˆ†ææ¸ˆã¿</strong><br>
            ã‚¹ã‚¿ã‚¤ãƒ«å: ${profile.style_name}<br>
            ç‰¹å¾´: ${profile.summary.substring(0, 100)}...
          </div>`;
      } else if (initState.hasSampleSheet) {
        styleDiv.innerHTML = '<div class="status status-info">ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ã‚·ãƒ¼ãƒˆãŒä½œæˆæ¸ˆã¿ã§ã™ã€‚æ–‡ä½“åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>';
      } else {
        styleDiv.innerHTML = '<div class="status status-info">ğŸ’¡ ã¾ãšã¯ã‚µãƒ³ãƒ—ãƒ«ç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</div>';
      }
    }

    function updateCellInfo() {
      const cellInfoDiv = document.getElementById('cellInfo');
      if (initState.activeInfo) {
        const info = initState.activeInfo;
        cellInfoDiv.innerHTML = `é¸æŠä¸­: ${info.sheetName}!${info.a1Notation} (è¡Œ${info.row}, åˆ—${info.col})`;
      } else {
        cellInfoDiv.innerHTML = 'ã‚»ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆA1ã‚»ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œã¾ã™ï¼‰';
      }
    }

    function generateNewsletter() {
      const memoText = document.getElementById('memoText').value.trim();
      const goalCode = document.getElementById('goalCode').value;
      const charCount = parseInt(document.getElementById('charCount').value) || null;
      const gradeLevel = document.getElementById('gradeLevel').value;

      if (!memoText) {
        showError('ç®‡æ¡æ›¸ããƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      if (!initState.apiKeySaved) {
        showError('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      showLoading(true);
      document.getElementById('generateBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          showSuccess(`å­¦ç´šé€šä¿¡ã‚’ä½œæˆã—ã¾ã—ãŸï¼\næ›¸ãå‡ºã—å…ˆ: ${result.writtenTo}\nå‡¦ç†ã—ãŸãƒ¡ãƒ¢: ${result.processedMemos}ä»¶\næ–‡å­—æ•°: ${result.textLength}å­—`);
          showLoading(false);
          document.getElementById('generateBtn').disabled = false;
          setTimeout(init, 1000);
        })
        .withFailureHandler(function(error) {
          showError('ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          showLoading(false);
          document.getElementById('generateBtn').disabled = false;
        })
        .generateNewsletter({
          memoText: memoText,
          goalCode: goalCode,
          charCount: charCount,
          gradeLevel: gradeLevel
        });
    }

    function loadSelectedCells() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(content) {
          if (content) {
            document.getElementById('memoText').value = content;
            showSuccess('é¸æŠã‚»ãƒ«ã®å†…å®¹ã‚’å–å¾—ã—ã¾ã—ãŸã€‚');
          } else {
            showWarning('ã‚»ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ã€å†…å®¹ãŒç©ºã§ã™ã€‚');
          }
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          showError('ã‚»ãƒ«å†…å®¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          showLoading(false);
        })
        .getSelectedCellContent();
    }

    function testCellWrite() {
      const testText = `ãƒ†ã‚¹ãƒˆæ–‡ç« ã§ã™ã€‚\nç¾åœ¨æ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}\n\nã“ã®æ–‡ç« ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ã€æ›¸ãè¾¼ã¿æ©Ÿèƒ½ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚`;
      
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          showSuccess(`ãƒ†ã‚¹ãƒˆæ›¸ãè¾¼ã¿æˆåŠŸï¼\næ›¸ãå‡ºã—å…ˆ: ${result.writtenTo}\næ–‡å­—æ•°: ${result.textLength}å­—`);
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          showError('ãƒ†ã‚¹ãƒˆæ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          showLoading(false);
        })
        .writeToSpecificCell('Sheet1', 'A1', testText);
    }

    function createSampleSheet() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function() {
          showSuccess('ã‚µãƒ³ãƒ—ãƒ«ç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚Aåˆ—ã«éå»ã®å­¦ç´šé€šä¿¡ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
          initState.hasSampleSheet = true;
          updateStyleStatus();
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          showError('ã‚·ãƒ¼ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          showLoading(false);
        })
        .ensureSampleSheet();
    }

    function analyzeStyle() {
      if (!initState.apiKeySaved) {
        showError('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      showLoading(true);
      document.getElementById('analyzeBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(profile) {
          showSuccess('æ–‡ä½“åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼');
          initState.styleProfileSummary = profile;
          updateStyleStatus();
          showLoading(false);
          document.getElementById('analyzeBtn').disabled = false;
        })
        .withFailureHandler(function(error) {
          showError('æ–‡ä½“åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          showLoading(false);
          document.getElementById('analyzeBtn').disabled = false;
        })
        .analyzeMyStyle();
    }

    function showProfileSheet() {
      google.script.run
        .withSuccessHandler(function() {
          showSuccess('æ–‡ä½“ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚');
        })
        .withFailureHandler(function(error) {
          showError('ã‚·ãƒ¼ãƒˆè¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .showProfileSheet();
    }

    function saveApiKey() {
      const key = document.getElementById('apiKey').value.trim();
      if (!key) {
        showError('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      showLoading(true);
      google.script.run
        .withSuccessHandler(function() {
          showSuccess('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
          initState.apiKeySaved = true;
          updateStatus();
          document.getElementById('apiKey').value = '';
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          showError('APIã‚­ãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          showLoading(false);
        })
        .saveApiKey(key);
    }

    function deleteApiKey() {
      if (!confirm('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      showLoading(true);
      google.script.run
        .withSuccessHandler(function() {
          showSuccess('APIã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
          initState.apiKeySaved = false;
          updateStatus();
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          showError('APIã‚­ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          showLoading(false);
        })
        .deleteApiKey();
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('show', show);
    }

    function showMessage(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status status-${type}">${message.replace(/\n/g, '<br>')}</div>`;
      setTimeout(() => { if (initState) updateStatus(); }, 8000);
    }

    function showSuccess(message) { showMessage('âœ… ' + message, 'success'); }
    function showError(message) { showMessage('âŒ ' + message, 'error'); }
    function showWarning(message) { showMessage('âš ï¸ ' + message, 'warning'); }
    function showInfo(message) { showMessage('â„¹ï¸ ' + message, 'info'); }

    init();
  </script>
</body>
</html>
